<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>All Courses</title>
    <style>
        /* Ensure that main content starts below the navbar */
        .w3-main {
            margin-top: 50px;
            /* Adjust this value based on the height of your navbar */
        }

        .no-courses {
            font-size: 2em;
            font-weight: lighter;
            text-align: center;
            margin-top: 50px;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <div class="w3-top">
        <div class="w3-bar w3-theme w3-top w3-left-align w3-large">
            <a class="w3-bar-item w3-button w3-right w3-hide-large w3-hover-white w3-large w3-theme-l1"
                href="javascript:void(0)" onclick="w3_open()"><i class="fa fa-bars"></i></a>
            <a href="/index" class="w3-bar-item w3-button w3-theme-l1">Home</a>
            <a href="/courses" class="w3-bar-item w3-button w3-hover-black">All Courses</a>
            <a href="/enrolled" class="w3-bar-item w3-button w3-black">Currently Enrolled</a>
            <a href="/completed" class="w3-bar-item w3-button w3-black">Completed</a>
            <% if (isInstructor) { %>
                <a href="/coursesForm" class="w3-bar-item w3-button w3-black">Add a Course</a>
                <a href="/myCourses" class="w3-bar-item w3-button w3-black">Edit a Course</a>
                <% } %>
                    <a href="/logout" class="w3-bar-item w3-button w3-black">Logout</a>
                    <a href="javascript:void(0)" onclick="w3_open()"
                        class="w3-bar-item w3-button w3-right w3-hide-large w3-hover-white w3-large w3-theme-l1"
                        title="Open Menu"><i class="fa fa-bars"></i></a>

                    <!-- Search bar -->
                    <form class="w3-bar-item w3-hide-small w3-right">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchText" placeholder="Search courses"
                                name="query">
                            <a id="searchButton" class="btn btn-outline-light" href="#"
                                onclick="performSearch()">Search</a>
                        </div>
                    </form>
        </div>
    </div>

    <!-- Sidebar -->
    <nav style="width:17.2%; top:0; margin-top: 52px;"
        class="w3-sidebar w3-bar-block w3-collapse w3-large w3-theme-l5 w3-animate-left" id="mySidebar">
        <a href="javascript:void(0)" onclick="w3_close()"
            class="w3-right w3-xlarge w3-padding-large w3-hover-black w3-hide-large" title="Close Menu">
            <i class="fa fa-remove"></i>
        </a>
        <a href="/index" style="text-decoration: none;"><h4 class="w3-bar-item"><b>Menu</b></h4></a>
        <a class="w3-bar-item w3-button w3-black" href="/courses">All Courses</a>
        <a class="w3-bar-item w3-button w3-hover-black" href="/enrolled">Currently Enrolled</a>
        <a class="w3-bar-item w3-button w3-hover-black" href="/completed">Completed</a>
        <% if (isInstructor) { %>
            <a class="w3-bar-item w3-button w3-hover-black" href="/coursesForm">Add a Course</a>
            <a class="w3-bar-item w3-button w3-hover-black" href="/myCourses">Edit a Course</a>
            <% } %>
                <a class="w3-bar-item w3-button w3-hover-black" href="/logout">Logout</a>
    </nav>

    <!-- Overlay effect when opening sidebar on small screens -->
    <div class="w3-overlay w3-hide-large" onclick="w3_close()" style="cursor:pointer" title="close side menu"
        id="myOverlay"></div>

    <!-- Main content: shift it to the right by 250 pixels when the sidebar is visible -->
    <div class="w3-main" style="margin-left:250px">
        <div class="row justify-content-center" id="coursesRow">
            <!-- Course cards will be dynamically added here -->
            <% if (courses.length===0) { %>
                <div class="no-courses">No courses present here</div>
                <% } else { %>
                    <% courses.forEach(course=> { %>
                        <div class='col-3 p-2 m-1 mt-5 shadow rounded bg-light'>
                            <div style="display: flex; flex-direction: column;" class="p-1">
                                <div style="height: 120px">
                                    <!-- Course title -->
                                    <h2>
                                        <%= course.title %>
                                    </h2>
                                </div>
                                <div style="margin-top: auto; height:75px">
                                    <!-- Course description -->
                                    <p>
                                        <%= course.description %>
                                    </p>
                                </div>
                                <!-- Course instructor -->
                                <div class="d-flex justify-content-between">
                                    <!-- Course instructor -->
                                    <div>
                                        <strong>Instructor:</strong>
                                        <%= course.instructor %>
                                    </div>
                                    <!-- Course cost -->
                                    <div>
                                        <strong>Cost:</strong>
                                        Rs. <%= course.cost %>
                                    </div>
                                </div>


                                <!-- Button to mark as completed -->
                                <div style="display: flex;">
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                        data-bs-target="#exampleModal_<%= course._id %>"
                                        style="margin-top: 5px; width: 1500px; height: 50px; padding-bottom: 5px;;">
                                        Click here to know more
                                    </button>
                                    <div style="display: flex;">
                                        <% if (coursesOngoing.includes(course._id)) { %>
                                            <a href="/courses/<%= course._id %>" class="btn btn-primary ms-2"
                                                style="margin-top: 5px; width: 150px; height: 50px; padding-top: 13px;">
                                                Go to Course
                                            </a>
                                            <% } else { %>
                                                <button
                                                    onclick="buyCourse('<%= course._id %>', '<%= course.title %>', '<%= course.cost %>', '<%= key %>', '<%= name %>', '<%= email %>')"
                                                    class="btn btn-primary ms-2" style="margin-top: 5px; width: 150px; height: 50px;">
                                                    Buy Course
                                                </button>
                                                <% } %>
                                    </div>
                                </div>


                                <!-- Modal for course details -->
                                <div class="modal fade" id="exampleModal_<%= course._id %>" tabindex="-1"
                                    aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h1 class="modal-title fs-5" id="exampleModalLabel">
                                                    <%= course.title %>
                                                </h1>
                                                <button type="button" class="btn-close pt-2" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <!-- List of section titles -->
                                                <h5>Sections:</h5>
                                                <% course.sections.forEach((section, index)=> { %>
                                                    <li><strong>Section <%= index + 1 %>:</strong>
                                                        <%= section.title %>
                                                    </li>
                                                    <% }); %>
                                                        <!-- Add more details here if needed -->
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <% }); %>
                            <% } %>
        </div>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        function performSearch() {
            console.log("Hello")
            // Get the value from the search input field
            var searchText = $('#searchText').val();

            // Construct the search URL with the search text
            var searchUrl = '/courses/search/' + encodeURIComponent(searchText);

            // Navigate to the search URL
            window.location.href = searchUrl;
        }
        function buyCourse(courseId, courseTitle, courseCost, key, name, email) {
            // Construct the request body
            const body = {
                courseId: courseId,
                amount: courseCost * 100,
                currency: 'INR',
                receipt: Math.random().toString(36).substring(7),
                notes: { title: courseTitle }
            };

            fetch('/createOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    var options = {
                        "key": key,
                        "amount": courseCost,
                        "currency": "INR",
                        "name": courseTitle,
                        "description": "Pay & Checkout this Course",
                        "image": "https://media.geeksforgeeks.org/wp-content/uploads/ 20210806114908/dummy-200x200.png",
                        "order_id": data.id,
                        "handler": async function (res) {
                            console.log(res)
                            let paymentId = res.razorpay_payment_id
                            let orderId = res.razorpay_order_id
                            await fetch('/verifyOrder', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: { order_id: orderId, payment_id: paymentId }
                            })
                            alert("Payment Successful")
                            alert("This step of Payment Succeeded");
                            window.location.href=`/courses/start/${courseId}`
                        },
                        "prefill": {
                            //Here we are prefilling random contact 
                            "contact": "1234567890",
                            //name and email id, so while checkout 
                            "name": name,
                            "email": email
                        },
                        "notes": {
                            "title": courseTitle
                        },
                        "theme": {
                            "color": "#2300a3"
                        }
                    };
                    var razorpayObject = new Razorpay(options);
                    razorpayObject.open();
                })
        }
    </script>
</body>

</html>